{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">Admin Dashboard</h2>
    <p class="text-muted mb-0">Welcome back, {{ current_user.username }}.</p>
  </div>
  <div class="text-end">
    <small class="text-muted" id="currentTime"></small>
  </div>
</div>

<!-- Stats Cards with Animations -->
<div class="row g-4 mb-4">
  <div class="col-xl-3 col-lg-4 col-md-6">
    <div class="card kpi">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-primary"><i class="fas fa-laptop"></i></div>
        <div>
          <div class="label">Total Assets</div>
          <div class="value">{{ total_assets }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-lg-4 col-md-6">
    <div class="card kpi">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-success"><i class="fas fa-users"></i></div>
        <div>
          <div class="label">Employees</div>
          <div class="value">{{ total_employees }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-lg-4 col-md-6">
    <div class="card kpi">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-warning"><i class="fas fa-certificate"></i></div>
        <div>
          <div class="label">Software Licenses</div>
          <div class="value">{{ total_licenses }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-lg-4 col-md-6">
    <div class="card kpi">
      <div class="card-body d-flex align-items-center">
        <div class="me-3 text-danger"><i class="fas fa-tools"></i></div>
        <div>
          <div class="label">Maintenance Records</div>
          <div class="value">{{ maintenance_count }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card chart-card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="card-title mb-0 d-flex align-items-center">
          <i class="fas fa-chart-pie me-2 text-primary"></i>
          Asset Distribution by Type
        </h5>
      </div>
      <div class="card-body chart-area">
        <canvas id="assetTypeChart"></canvas>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card chart-card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="card-title mb-0 d-flex align-items-center">
          <i class="fas fa-chart-line me-2 text-success"></i>
          Monthly Maintenance Cost (GH₵)
        </h5>
      </div>
      <div class="card-body chart-area">
        <canvas id="maintenanceCostChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <h5 class="card-title mb-0 d-flex align-items-center">
          <i class="fas fa-bolt me-2 text-warning"></i>
          Quick Actions
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <a href="{{ url_for('main.assets') }}" class="btn btn-primary w-100 hover-scale">
              <i class="fas fa-plus me-2"></i>Add Asset
            </a>
          </div>
          <div class="col-md-3">
            <a href="{{ url_for('main.employees') }}" class="btn btn-success w-100 hover-scale">
              <i class="fas fa-user-plus me-2"></i>Add Employee
            </a>
          </div>
          <div class="col-md-3">
            <a href="{{ url_for('main.maintenance_list') }}" class="btn btn-warning w-100 hover-scale">
              <i class="fas fa-wrench me-2"></i>Maintenance
            </a>
          </div>
          <div class="col-md-3">
            <a href="{{ url_for('main.licenses') }}" class="btn btn-info w-100 hover-scale">
              <i class="fas fa-key me-2"></i>Licenses
            </a>
          </div>
        </div>
        <hr>
        <h6 class="mb-3">Pending Maintenance Approvals</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light"><tr><th scope="col">ID</th><th scope="col">Asset</th><th scope="col">Date</th><th scope="col">Description</th><th scope="col" class="text-end">Action</th></tr></thead>
            <tbody>
              {% for pm in pending_maintenances %}
              <tr>
                <td>{{ pm.id }}</td>
                <td>{{ pm.asset.asset_id if pm.asset else pm.asset_id }}</td>
                <td>{{ pm.date }}</td>
                <td>{{ pm.description }}</td>
                <td class="text-end">
                  <form method="post">
                    <button type="submit" formaction="{{ url_for('main.maintenance_approve', mid=pm.id) }}" class="btn btn-sm btn-success">Approve</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="text-muted">No pending requests.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h6 class="mb-3 mt-4">Recently Approved</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light"><tr><th scope="col">ID</th><th scope="col">Asset</th><th scope="col">Approved At</th><th scope="col">Approved By</th></tr></thead>
            <tbody>
              {% for ra in recent_approved %}
              <tr>
                <td>{{ ra.id }}</td>
                <td>{{ ra.asset.asset_id if ra.asset else ra.asset_id }}</td>
                <td>{{ ra.approved_at }}</td>
                <td>{{ ra.approved_by }}</td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-muted">No approvals yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.chart-card { border: 1px solid #eef1f5; border-radius: 12px; overflow: hidden; }
.chart-area { height: 360px; }
</style>

<script>
// Update current time
function updateTime() {
  const now = new Date();
  const timeString = now.toLocaleString('en-US', {
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  document.getElementById('currentTime').textContent = timeString;
}

updateTime();
setInterval(updateTime, 60000);

// No animated counters for a calmer UI

// Asset Distribution Doughnut Chart with no-data fallback
(function() {
  const labels = {{ asset_types|tojson|safe }};
  const dataVals = {{ asset_counts|tojson|safe }};
  const total = (dataVals || []).reduce((a, b) => a + b, 0);
  const canvas = document.getElementById('assetTypeChart');
  if (!total) {
    canvas.replaceWith(Object.assign(document.createElement('div'), { className: 'text-muted text-center py-5', innerText: 'No asset distribution data' }));
    return;
  }
  const colors = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ab'];
  new Chart(canvas.getContext('2d'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data: dataVals, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const value = ctx.parsed;
              const pct = ((value / total) * 100).toFixed(1);
              return `${ctx.label}: ${value} (${pct}%)`;
            }
          }
        }
      },
      cutout: '55%'
    }
  });
})();

// Monthly Maintenance Cost Line Chart with currency formatting and no-data fallback
(function() {
  const labels = {{ months|tojson|safe }};
  const dataVals = {{ monthly_costs|tojson|safe }};
  const sum = (dataVals || []).reduce((a,b) => a + b, 0);
  const canvas = document.getElementById('maintenanceCostChart');
  if (!sum) {
    canvas.replaceWith(Object.assign(document.createElement('div'), { className: 'text-muted text-center py-5', innerText: 'No maintenance cost data' }));
    return;
  }
  new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Maintenance Cost (GH₵)',
        data: dataVals,
        borderColor: '#4e79a7',
        backgroundColor: 'rgba(78, 121, 167, 0.12)',
        borderWidth: 2,
        fill: true,
        tension: 0.35,
        pointRadius: 3,
        pointHoverRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const v = ctx.parsed.y || 0;
              return ' GH₵' + v.toLocaleString('en-GH');
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => 'GH₵' + Number(v).toLocaleString('en-GH') },
          grid: { color: 'rgba(0,0,0,0.08)' }
        },
        x: { grid: { display: false } }
      }
    }
  });
})();

// Add interactive hover effects to cards
document.querySelectorAll('.stat-card').forEach(card => {
  card.addEventListener('mouseenter', function() {
    this.style.transform = 'translateY(-8px) scale(1.02)';
  });
  
  card.addEventListener('mouseleave', function() {
    this.style.transform = 'translateY(0) scale(1)';
  });
});

// Add click animation to quick action buttons
document.querySelectorAll('.hover-scale').forEach(button => {
  button.addEventListener('click', function() {
    this.style.transform = 'scale(0.95)';
    setTimeout(() => {
      this.style.transform = 'scale(1)';
    }, 150);
  });
});
</script>
{% endblock %}
